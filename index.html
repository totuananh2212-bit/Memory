<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wol - Khu vườn số</title>
<style>
  :root{
    --bg:#081018; --panel:rgba(0,0,0,0.45); --accent:#0a7a6b; --muted:#9fb8af; --danger:#e05b5b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#e6fff9;min-height:100vh;
    background-image: url('https://i.ibb.co/8x2Qx6W/leaf-pattern.png'); background-size:cover;}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:linear-gradient(90deg,#021018,#002a2a);}
  header .left{display:flex;align-items:center;gap:12px}
  header img{width:44px;height:44px;border-radius:8px}
  header h1{margin:0;font-size:18px}
  nav{display:flex;gap:8px}
  nav button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer}
  nav button.active{background:var(--accent);color:#021;font-weight:700}
  main{display:flex;gap:16px;padding:16px}
  aside{width:260px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.18));border:1px solid rgba(255,255,255,0.03);height:calc(100vh - 110px);overflow:auto}
  .content{flex:1;height:calc(100vh - 110px);overflow:auto}
  .tab{display:none;padding:12px}
  .tab.active{display:block}
  .card{background:var(--panel);padding:12px;border-radius:8px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
  input[type=text], input[type=email], input[type=tel], textarea, select{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;margin-top:8px}
  textarea{min-height:90px;resize:vertical}
  .btn{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#021;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  .posts{display:flex;flex-direction:column;gap:12px;margin-top:12px}
  .post{padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15));border:1px solid rgba(255,255,255,0.03)}
  .meta{font-size:13px;color:var(--muted);margin-bottom:6px}
  .mediaRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  img.preview{max-width:220px;border-radius:8px;display:block}
  video.preview{max-width:320px;border-radius:8px;display:block}
  .actions{display:flex;gap:8px;align-items:center;margin-top:8px}
  .reaction{padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;background:transparent;color:var(--muted)}
  .reaction span.count{margin-left:6px;color:#fff;font-weight:700}
  .comment-box{margin-top:10px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:10px}
  .comment{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.01)}
  .small{font-size:13px;color:var(--muted)}
  .danger{color:var(--danger);cursor:pointer}
  .flex{display:flex;gap:8px;align-items:center}
  footer{padding:12px;text-align:center;color:var(--muted)}
  @media(max-width:900px){aside{display:none} main{padding:12px}}
</style>
</head>
<body>

<header>
  <div class="left">
    <img src="https://i.ibb.co/H4rF6zq/leaf-icon.png" alt="logo">
    <div>
      <h1 id="siteTitle">Wol - Khu vườn số</h1>
      <div class="small">Xanh đen, trang trí lá — lưu cục bộ (localStorage)</div>
    </div>
  </div>

  <nav id="mainNav">
    <button data-tab="tab-media" class="active">1. Ảnh & Video</button>
    <button data-tab="tab-stories">2. Câu chuyện</button>
    <button data-tab="tab-contact">3. Thông tin</button>
    <button data-tab="tab-reviews">4. Đánh giá</button>
    <button data-tab="tab-settings">⚙️ Cài đặt</button>
  </nav>
</header>

<main>
  <aside>
    <div class="card">
      <div class="small">Tên mặc định khi bình luận (không bắt buộc)</div>
      <input id="defaultName" placeholder="Ví dụ: Khách vãng lai">
      <div style="margin-top:8px" class="flex">
        <button class="btn" onclick="saveDefaultName()">Lưu</button>
        <button class="btn ghost" onclick="clearDefaultName()">Xóa</button>
      </div>
    </div>

    <div class="card">
      <div class="small">Ảnh nền / tiêu đề (cài đặt cũng có thể đổi)</div>
      <input id="quickBgUrl" placeholder="Dán link ảnh nền...">
      <div style="margin-top:8px" class="flex">
        <button class="btn ghost" onclick="applyQuickBg()">Áp dụng nền</button>
      </div>
      <div style="margin-top:8px" class="small">Xóa toàn bộ dữ liệu (localStorage)</div>
      <div style="margin-top:8px" class="flex">
        <button class="btn ghost" onclick="wipeAll()">XÓA TOÀN BỘ</button>
      </div>
    </div>
  </aside>

  <section class="content">
    <!-- TAB 1: Media -->
    <div id="tab-media" class="tab active">
      <div class="card">
        <h2>1. Ảnh & Video — Tải lên từ máy</h2>
        <div class="small">Bạn có thể chọn nhiều file (images & videos). Dữ liệu được lưu cục bộ.</div>
        <label style="margin-top:8px" class="small">Mô tả (tùy chọn)</label>
        <textarea id="mediaDesc" placeholder="Mô tả bài đăng..."></textarea>
        <label class="small" style="margin-top:8px">Chọn file (images / videos) — multiple</label>
        <input id="mediaFiles" type="file" accept="image/*,video/*" multiple>
        <div style="margin-top:10px" class="flex">
          <button class="btn" onclick="addMediaPost()">Đăng & Lưu</button>
          <button class="btn ghost" onclick="renderMediaPosts()">Làm mới</button>
        </div>
      </div>

      <div id="mediaPosts" class="posts"></div>
    </div>

    <!-- TAB 2: Stories -->
    <div id="tab-stories" class="tab">
      <div class="card">
        <h2>2. Viết câu chuyện + tải ảnh minh họa</h2>
        <input id="storyTitle" placeholder="Tiêu đề (bắt buộc)">
        <textarea id="storyText" placeholder="Nội dung..."></textarea>
        <label class="small">Ảnh minh họa (tùy chọn)</label>
        <input id="storyImage" type="file" accept="image/*">
        <div style="margin-top:8px" class="flex">
          <button class="btn" onclick="addStory()">Đăng câu chuyện</button>
          <button class="btn ghost" onclick="renderStories()">Làm mới</button>
        </div>
      </div>

      <div id="storiesList" class="posts"></div>
    </div>

    <!-- TAB 3: Contact -->
    <div id="tab-contact" class="tab">
      <div class="card">
        <h2>3. Thông tin liên hệ (lưu & sửa)</h2>
        <input id="contactName" placeholder="Họ tên">
        <input id="contactPhone" placeholder="Số điện thoại">
        <input id="contactEmail" placeholder="Gmail">
        <div style="margin-top:8px" class="flex">
          <button class="btn" onclick="saveContact()">Lưu</button>
          <button class="btn ghost" onclick="loadContact()">Tải lại</button>
        </div>
      </div>

      <div id="savedContact" class="card small">Chưa có thông tin</div>
    </div>

    <!-- TAB 4: Reviews -->
    <div id="tab-reviews" class="tab">
      <div class="card">
        <h2>4. Đánh giá website (1–5 sao) + ảnh minh họa</h2>
        <div class="small">Chọn sao, viết nhận xét, tải ảnh (tùy chọn).</div>
        <label class="small">Số sao</label>
        <select id="reviewStars">
          <option value="1">1 ⭐</option>
          <option value="2">2 ⭐</option>
          <option value="3">3 ⭐</option>
          <option value="4">4 ⭐</option>
          <option value="5" selected>5 ⭐</option>
        </select>
        <textarea id="reviewText" placeholder="Nhận xét..."></textarea>
        <label class="small">Ảnh minh họa (tùy chọn)</label>
        <input id="reviewImage" type="file" accept="image/*">
        <div style="margin-top:8px" class="flex">
          <button class="btn" onclick="addReview()">Gửi đánh giá</button>
          <button class="btn ghost" onclick="renderReviews()">Làm mới</button>
        </div>
      </div>

      <div id="reviewsList" class="posts"></div>
    </div>

    <!-- SETTINGS -->
    <div id="tab-settings" class="tab">
      <div class="card">
        <h2>⚙️ Cài đặt (cần đăng nhập)</h2>
        <div class="small">Đăng nhập để thay đổi tiêu đề / ảnh nền. Tài khoản: <b>Toanh2212</b> / Mật khẩu: <b>22012000</b></div>
        <div style="margin-top:8px" class="flex">
          <input id="loginUser" placeholder="Tài khoản">
          <input id="loginPass" placeholder="Mật khẩu" type="password">
          <button class="btn" onclick="doLogin()">Đăng nhập</button>
          <button class="btn ghost" onclick="doLogout()">Đăng xuất</button>
        </div>
        <div id="loginStatus" class="small" style="margin-top:8px">Chưa đăng nhập</div>
      </div>

      <div class="card">
        <label class="small">Tiêu đề website</label>
        <input id="newTitle" placeholder="Tiêu đề mới...">
        <label class="small" style="margin-top:8px">Ảnh nền (tải file từ máy hoặc dán link)</label>
        <input id="bgFile" type="file" accept="image/*">
        <input id="bgUrl" placeholder="Hoặc dán link ảnh nền..." style="margin-top:8px">
        <div style="margin-top:8px" class="flex">
          <button class="btn" onclick="applySettings()">Lưu cài đặt</button>
        </div>
      </div>
    </div>

  </section>
</main>

<footer>
  <div class="small">Mọi dữ liệu lưu cục bộ trên trình duyệt (localStorage). Muốn chia sẻ rộng phải có server.</div>
</footer>

<script>
/* ===================== Khoá dữ liệu (localStorage keys) ===================== */
const KEY = {
  MEDIA: 'wol_media_posts_v3',
  STORIES: 'wol_stories_v3',
  CONTACT: 'wol_contact_v3',
  REVIEWS: 'wol_reviews_v3',
  SETTINGS: 'wol_settings_v3',
  DEFAULT_NAME: 'wol_default_name_v3'
};
const AUTH = { user: 'Toanh2212', pass: '22012000' };

/* Helpers */
function load(key){ try{ return JSON.parse(localStorage.getItem(key)||'null') }catch(e){ return null } }
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)) }
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6) }
function escapeHtml(t){ if(!t) return ''; return String(t).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;') }
function getDefaultName(){ return load(KEY.DEFAULT_NAME) || 'Người lạ' }
function setDefaultName(v){ save(KEY.DEFAULT_NAME, v) }

/* Init defaults */
if(!load(KEY.MEDIA)) save(KEY.MEDIA, []);
if(!load(KEY.STORIES)) save(KEY.STORIES, []);
if(!load(KEY.REVIEWS)) save(KEY.REVIEWS, []);
if(!load(KEY.SETTINGS)) save(KEY.SETTINGS, { title: document.getElementById('siteTitle').innerText, bg: '' });

/* Navigation */
document.querySelectorAll('#mainNav button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#mainNav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(tab).classList.add('active');

    // render tab content as needed
    if(tab==='tab-media') renderMediaPosts();
    if(tab==='tab-stories') renderStories();
    if(tab==='tab-contact') loadContact();
    if(tab==='tab-reviews') renderReviews();
  });
});

/* Quick aside default name */
function saveDefaultName(){
  const v = document.getElementById('defaultName').value.trim();
  if(!v){ alert('Nhập tên để lưu'); return; }
  setDefaultName(v);
  alert('Lưu tên mặc định xong');
}
function clearDefaultName(){ localStorage.removeItem(KEY.DEFAULT_NAME); document.getElementById('defaultName').value=''; alert('Đã xóa tên mặc định') }

/* Quick bg */
function applyQuickBg(){
  const url = document.getElementById('quickBgUrl').value.trim();
  if(!url) return alert('Dán link ảnh nền');
  document.body.style.backgroundImage = `url('${url}')`;
  const s = load(KEY.SETTINGS) || {};
  s.bg = url; save(KEY.SETTINGS, s);
  alert('Áp dụng nền xong');
}

/* Wipe all */
function wipeAll(){
  if(!confirm('Xác nhận xóa toàn bộ dữ liệu local trên trình duyệt này?')) return;
  localStorage.removeItem(KEY.MEDIA); localStorage.removeItem(KEY.STORIES); localStorage.removeItem(KEY.REVIEWS);
  localStorage.removeItem(KEY.CONTACT); localStorage.removeItem(KEY.DEFAULT_NAME); localStorage.removeItem(KEY.SETTINGS);
  location.reload();
}

/* ===================== TAB 1: Media posts (UPLOAD) ===================== */
/* Thực hiện đọc tất cả file (multiple) thành dataURL, sau đó lưu post object */
async function addMediaPost(){
  const desc = document.getElementById('mediaDesc').value.trim();
  const files = document.getElementById('mediaFiles').files;
  if(files.length===0 && !desc){ alert('Cần mô tả hoặc chọn file'); return; }

  // read files to dataURL
  const readers = Array.from(files).map(f => new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res({name:f.name, type:f.type, data:fr.result});
    fr.onerror = (e)=> rej(e);
    fr.readAsDataURL(f);
  }));

  let arr = [];
  try { arr = await Promise.all(readers); } catch(e){ alert('Lỗi đọc file'); console.error(e); return; }

  const posts = load(KEY.MEDIA) || [];
  const post = {
    id: uid(), desc, files: arr, created: new Date().toISOString(),
    likes:0, dislikes:0, loves:0,
    comments: []
  };
  posts.unshift(post);
  save(KEY.MEDIA, posts);

  // reset inputs and render
  document.getElementById('mediaDesc').value=''; document.getElementById('mediaFiles').value='';
  renderMediaPosts();
}

/* Render posts */
function renderMediaPosts(){
  const container = document.getElementById('mediaPosts'); container.innerHTML='';
  const posts = load(KEY.MEDIA) || [];
  for(const p of posts){
    const div = document.createElement('div'); div.className='post';
    let html = `<div class="meta"><strong>${escapeHtml(p.desc||'')}</strong> <span class="small">• ${new Date(p.created).toLocaleString()}</span></div>`;

    if(p.files && p.files.length){
      html += `<div class="mediaRow">`;
      for(const f of p.files){
        if(f.type.startsWith('image')) html += `<img class="preview" src="${f.data}" alt="${escapeHtml(f.name)}">`;
        else if(f.type.startsWith('video')) html += `<video class="preview" controls src="${f.data}"></video>`;
        else html += `<div class="small">File: ${escapeHtml(f.name)}</div>`;
      }
      html += `</div>`;
    }

    html += `<div class="actions">
      <button class="reaction" onclick="mediaReact('${p.id}','likes')">👍 <span class="count" id="m_like_${p.id}">${p.likes}</span></button>
      <button class="reaction" onclick="mediaReact('${p.id}','dislikes')">👎 <span class="count" id="m_dis_${p.id}">${p.dislikes}</span></button>
      <button class="reaction" onclick="mediaReact('${p.id}','loves')">❤️ <span class="count" id="m_love_${p.id}">${p.loves}</span></button>
      <div style="margin-left:auto" class="flex">
        <button class="btn ghost" onclick="editMediaPost('${p.id}')">Sửa mô tả</button>
        <button class="btn ghost danger" onclick="deleteMediaPost('${p.id}')">Xóa</button>
      </div>
    </div>`;

    // comments
    html += `<div class="comment-box" id="cbox_${p.id}">
      <div id="c_list_${p.id}"></div>
      <div style="margin-top:8px" class="flex">
        <input id="cname_${p.id}" placeholder="Tên (tùy ý)" style="flex:0 0 160px">
        <input id="ctext_${p.id}" placeholder="Viết bình luận..." style="flex:1">
        <button class="btn" onclick="addMediaComment('${p.id}')">Gửi</button>
      </div>
    </div>`;

    div.innerHTML = html;
    container.appendChild(div);
    renderMediaComments(p.id);
  }
}

/* Reactions on post */
function mediaReact(postId, field){
  const posts = load(KEY.MEDIA) || []; const p = posts.find(x=>x.id===postId); if(!p) return;
  p[field] = (p[field]||0) + 1;
  save(KEY.MEDIA, posts);
  // update counter immediate
  document.getElementById(`m_${field.slice(0,field==='loves'?'l':'d')}_${postId}`)?.innerText = p[field];
  renderMediaPosts();
}

/* Edit / Delete */
function editMediaPost(id){
  const posts = load(KEY.MEDIA)||[]; const p = posts.find(x=>x.id===id); if(!p) return;
  const newd = prompt('Sửa mô tả:', p.desc||'') || p.desc;
  p.desc = newd; save(KEY.MEDIA, posts); renderMediaPosts();
}
function deleteMediaPost(id){
  if(!confirm('Xác nhận xóa bài đăng?')) return;
  let posts = load(KEY.MEDIA)||[]; posts = posts.filter(x=>x.id!==id); save(KEY.MEDIA, posts); renderMediaPosts();
}

/* Comments on media */
function addMediaComment(postId){
  const name = (document.getElementById(`cname_${postId}`).value || '').trim() || getDefaultName();
  const text = (document.getElementById(`ctext_${postId}`).value || '').trim();
  if(!text) return alert('Viết bình luận trước');
  const posts = load(KEY.MEDIA) || []; const p = posts.find(x=>x.id===postId); if(!p) return;
  p.comments.push({ id: uid(), name, text, t: new Date().toISOString(), likes:0, dislikes:0, loves:0 });
  save(KEY.MEDIA, posts);
  document.getElementById(`cname_${postId}`).value=''; document.getElementById(`ctext_${postId}`).value='';
  renderMediaComments(postId);
}
function renderMediaComments(postId){
  const posts = load(KEY.MEDIA)||[]; const p = posts.find(x=>x.id===postId);
  const container = document.getElementById(`c_list_${postId}`);
  if(!p){ container.innerHTML=''; return; }
  container.innerHTML = '';
  for(const c of p.comments){
    const div = document.createElement('div'); div.className='comment';
    div.innerHTML = `<div><b>${escapeHtml(c.name)}</b> • <span class="small">${new Date(c.t).toLocaleString()}</span><div>${escapeHtml(c.text)}</div></div>
      <div style="text-align:right;min-width:160px">
        <button class="reaction" onclick="commentReactMedia('${postId}','${c.id}','likes')">👍 <span class="count">${c.likes||0}</span></button>
        <button class="reaction" onclick="commentReactMedia('${postId}','${c.id}','dislikes')">👎 <span class="count">${c.dislikes||0}</span></button>
        <button class="reaction" onclick="commentReactMedia('${postId}','${c.id}','loves')">❤️ <span class="count">${c.loves||0}</span></button>
        <div style="margin-top:6px"><button class="btn ghost danger" onclick="deleteMediaComment('${postId}','${c.id}')">Xóa</button></div>
      </div>`;
    container.appendChild(div);
  }
}
function commentReactMedia(postId, commentId, field){
  const posts = load(KEY.MEDIA)||[]; const p = posts.find(x=>x.id===postId); if(!p) return;
  const c = p.comments.find(x=>x.id===commentId); if(!c) return;
  c[field] = (c[field]||0) + 1; save(KEY.MEDIA, posts); renderMediaComments(postId);
}
function deleteMediaComment(postId, commentId){
  if(!confirm('Xóa bình luận?')) return;
  const posts = load(KEY.MEDIA)||[]; const p = posts.find(x=>x.id===postId); if(!p) return;
  p.comments = (p.comments||[]).filter(x=>x.id!==commentId); save(KEY.MEDIA, posts); renderMediaComments(postId);
}

/* ===================== TAB 2: Stories (upload 1 image) ===================== */
async function addStory(){
  const title = document.getElementById('storyTitle').value.trim();
  const text = document.getElementById('storyText').value.trim();
  const f = document.getElementById('storyImage').files[0];
  if(!title || !text){ alert('Cần tiêu đề và nội dung'); return; }

  let img = null;
  if(f){
    try{
      img = await new Promise((res, rej)=>{
        const fr = new FileReader();
        fr.onload = ()=> res({ name: f.name, type: f.type, data: fr.result });
        fr.onerror = rej; fr.readAsDataURL(f);
      });
    }catch(e){ alert('Lỗi đọc ảnh'); console.error(e); return; }
  }

  const stories = load(KEY.STORIES) || [];
  stories.unshift({ id: uid(), title, text, img, created: new Date().toISOString(), likes:0, dislikes:0, loves:0, comments: [] });
  save(KEY.STORIES, stories);
  document.getElementById('storyTitle').value=''; document.getElementById('storyText').value=''; document.getElementById('storyImage').value='';
  renderStories();
}

function renderStories(){
  const container = document.getElementById('storiesList'); container.innerHTML='';
  const stories = load(KEY.STORIES) || [];
  for(const s of stories){
    const div = document.createElement('div'); div.className='post';
    let html = `<div class="meta"><strong>${escapeHtml(s.title)}</strong> <span class="small">• ${new Date(s.created).toLocaleString()}</span></div>`;
    html += `<div>${escapeHtml(s.text)}</div>`;
    if(s.img) html += `<div class="mediaRow"><img class="preview" src="${s.img.data}" alt="${escapeHtml(s.img.name)}"></div>`;
    html += `<div class="actions">
      <button class="reaction" onclick="storyReact('${s.id}','likes')">👍 <span class="count">${s.likes}</span></button>
      <button class="reaction" onclick="storyReact('${s.id}','dislikes')">👎 <span class="count">${s.dislikes}</span></button>
      <button class="reaction" onclick="storyReact('${s.id}','loves')">❤️ <span class="count">${s.loves}</span></button>
      <div style="margin-left:auto" class="flex">
        <button class="btn ghost" onclick="editStory('${s.id}')">Sửa</button>
        <button class="btn ghost danger" onclick="deleteStory('${s.id}')">Xóa</button>
      </div>
    </div>
    <div class="comment-box" id="s_cbox_${s.id}">
      <div id="s_c_list_${s.id}"></div>
      <div style="margin-top:8px" class="flex">
        <input id="s_cname_${s.id}" placeholder="Tên (tùy ý)" style="flex:0 0 160px">
        <input id="s_ctext_${s.id}" placeholder="Bình luận..." style="flex:1">
        <button class="btn" onclick="addStoryComment('${s.id}')">Gửi</button>
      </div>
    </div>`;
    div.innerHTML = html;
    container.appendChild(div);
    renderStoryComments(s.id);
  }
}

function storyReact(id, field){ const arr = load(KEY.STORIES)||[]; const s = arr.find(x=>x.id===id); if(!s) return; s[field] = (s[field]||0)+1; save(KEY.STORIES, arr); renderStories(); }
function editStory(id){ const arr = load(KEY.STORIES)||[]; const s = arr.find(x=>x.id===id); if(!s) return; s.title = prompt('Sửa tiêu đề', s.title)||s.title; s.text = prompt('Sửa nội dung', s.text)||s.text; save(KEY.STORIES, arr); renderStories(); }
function deleteStory(id){ if(!confirm('Xóa câu chuyện?')) return; let arr = load(KEY.STORIES)||[]; arr = arr.filter(x=>x.id!==id); save(KEY.STORIES, arr); renderStories(); }

function addStoryComment(storyId){
  const name = (document.getElementById(`s_cname_${storyId}`).value||'').trim() || getDefaultName();
  const text = (document.getElementById(`s_ctext_${storyId}`).value||'').trim();
  if(!text) return alert('Viết bình luận');
  const arr = load(KEY.STORIES)||[]; const s = arr.find(x=>x.id===storyId); if(!s) return;
  s.comments.push({ id: uid(), name, text, t: new Date().toISOString(), likes:0, dislikes:0, loves:0 });
  save(KEY.STORIES, arr); document.getElementById(`s_cname_${storyId}`).value=''; document.getElementById(`s_ctext_${storyId}`).value='';
  renderStoryComments(storyId);
}
function renderStoryComments(storyId){
  const arr = load(KEY.STORIES)||[]; const s = arr.find(x=>x.id===storyId); const box = document.getElementById(`s_c_list_${storyId}`); if(!s){ if(box) box.innerHTML=''; return; }
  box.innerHTML='';
  for(const c of s.comments){
    const d = document.createElement('div'); d.className='comment';
    d.innerHTML = `<div><b>${escapeHtml(c.name)}</b> • <span class="small">${new Date(c.t).toLocaleString()}</span><div>${escapeHtml(c.text)}</div></div>
      <div style="text-align:right;min-width:160px">
        <button class="reaction" onclick="storyCommentReact('${storyId}','${c.id}','likes')">👍 <span class="count">${c.likes||0}</span></button>
        <button class="reaction" onclick="storyCommentReact('${storyId}','${c.id}','dislikes')">👎 <span class="count">${c.dislikes||0}</span></button>
        <button class="reaction" onclick="storyCommentReact('${storyId}','${c.id}','loves')">❤️ <span class="count">${c.loves||0}</span></button>
        <div style="margin-top:6px"><button class="btn ghost danger" onclick="deleteStoryComment('${storyId}','${c.id}')">Xóa</button></div>
      </div>`;
    box.appendChild(d);
  }
}
function storyCommentReact(storyId, cid, field){
  const arr = load(KEY.STORIES)||[]; const s = arr.find(x=>x.id===storyId); if(!s) return; const c = s.comments.find(x=>x.id===cid); if(!c) return; c[field] = (c[field]||0)+1; save(KEY.STORIES, arr); renderStoryComments(storyId);
}
function deleteStoryComment(storyId, cid){ if(!confirm('Xóa bình luận?')) return; const arr = load(KEY.STORIES)||[]; const s = arr.find(x=>x.id===storyId); if(!s) return; s.comments = s.comments.filter(x=>x.id!==cid); save(KEY.STORIES, arr); renderStoryComments(storyId); }

/* ===================== TAB 3: Contact ===================== */
function saveContact(){
  const name = document.getElementById('contactName').value.trim();
  if(!name) return alert('Nhập họ tên');
  const phone = document.getElementById('contactPhone').value.trim();
  const email = document.getElementById('contactEmail').value.trim();
  const obj = { name, phone, email, saved: new Date().toISOString() };
  save(KEY.CONTACT, obj);
  renderContact(obj); alert('Đã lưu thông tin');
}
function loadContact(){
  const c = load(KEY.CONTACT);
  if(c){
    document.getElementById('contactName').value = c.name||'';
    document.getElementById('contactPhone').value = c.phone||'';
    document.getElementById('contactEmail').value = c.email||'';
    renderContact(c);
  } else {
    document.getElementById('savedContact').innerText = 'Chưa có thông tin.';
  }
}
function renderContact(c){
  const el = document.getElementById('savedContact');
  el.innerHTML = `<div><b>${escapeHtml(c.name)}</b></div><div class="small">Phone: ${escapeHtml(c.phone||'-')}</div><div class="small">Email: ${escapeHtml(c.email||'-')}</div>
    <div style="margin-top:8px"><button class="btn ghost" onclick="deleteContact()">Xóa</button></div>`;
}
function deleteContact(){ if(!confirm('Xóa thông tin liên hệ?')) return; localStorage.removeItem(KEY.CONTACT); loadContact(); }

/* ===================== TAB 4: Reviews ===================== */
async function addReview(){
  const stars = Number(document.getElementById('reviewStars').value);
  const text = document.getElementById('reviewText').value.trim();
  const f = document.getElementById('reviewImage').files[0];
  let img = null;
  if(f){
    try{ img = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res({name:f.name,type:f.type,data:fr.result}); fr.onerror=rej; fr.readAsDataURL(f); }); }
    catch(e){ alert('Lỗi đọc ảnh'); return; }
  }
  const reviews = load(KEY.REVIEWS) || [];
  reviews.unshift({ id: uid(), stars, text, img, created: new Date().toISOString(), likes:0, dislikes:0, loves:0, comments:[] });
  save(KEY.REVIEWS, reviews);
  document.getElementById('reviewText').value=''; document.getElementById('reviewImage').value='';
  renderReviews();
}

function renderReviews(){
  const container = document.getElementById('reviewsList'); container.innerHTML='';
  const reviews = load(KEY.REVIEWS) || [];
  for(const r of reviews){
    const div = document.createElement('div'); div.className='post';
    let html = `<div class="meta"><strong>${'★'.repeat(r.stars)}${'☆'.repeat(5-r.stars)}</strong> <span class="small">• ${new Date(r.created).toLocaleString()}</span></div>`;
    html += `<div>${escapeHtml(r.text||'')}</div>`;
    if(r.img) html += `<div class="mediaRow"><img class="preview" src="${r.img.data}" alt="${escapeHtml(r.img.name)}"></div>`;
    html += `<div class="actions">
      <button class="reaction" onclick="reviewReact('${r.id}','likes')">👍 <span class="count">${r.likes}</span></button>
      <button class="reaction" onclick="reviewReact('${r.id}','dislikes')">👎 <span class="count">${r.dislikes}</span></button>
      <button class="reaction" onclick="reviewReact('${r.id}','loves')">❤️ <span class="count">${r.loves}</span></button>
      <div style="margin-left:auto" class="flex"><button class="btn ghost" onclick="deleteReview('${r.id}')">Xóa</button></div>
    </div>
    <div class="comment-box" id="rv_cbox_${r.id}">
      <div id="rv_c_list_${r.id}"></div>
      <div style="margin-top:8px" class="flex">
        <input id="rv_cname_${r.id}" placeholder="Tên (tùy ý)" style="flex:0 0 160px">
        <input id="rv_ctext_${r.id}" placeholder="Bình luận..." style="flex:1">
        <button class="btn" onclick="addReviewComment('${r.id}')">Gửi</button>
      </div>
    </div>`;
    div.innerHTML = html; container.appendChild(div); renderReviewComments(r.id);
  }
}
function reviewReact(id, field){ const a = load(KEY.REVIEWS)||[]; const r = a.find(x=>x.id===id); if(!r) return; r[field] = (r[field]||0)+1; save(KEY.REVIEWS, a); renderReviews(); }
function deleteReview(id){ if(!confirm('Xác nhận xóa đánh giá?')) return; let a = load(KEY.REVIEWS)||[]; a = a.filter(x=>x.id!==id); save(KEY.REVIEWS,a); renderReviews(); }

function addReviewComment(reviewId){
  const name = (document.getElementById(`rv_cname_${reviewId}`).value||'').trim() || getDefaultName();
  const text = (document.getElementById(`rv_ctext_${reviewId}`).value||'').trim();
  if(!text) return alert('Viết bình luận');
  const a = load(KEY.REVIEWS)||[]; const r = a.find(x=>x.id===reviewId); if(!r) return;
  r.comments.push({ id: uid(), name, text, t: new Date().toISOString(), likes:0, dislikes:0, loves:0 });
  save(KEY.REVIEWS, a); document.getElementById(`rv_cname_${reviewId}`).value=''; document.getElementById(`rv_ctext_${reviewId}`).value='';
  renderReviewComments(reviewId);
}
function renderReviewComments(reviewId){
  const a = load(KEY.REVIEWS)||[]; const r = a.find(x=>x.id===reviewId); const box = document.getElementById(`rv_c_list_${reviewId}`); if(!r){ if(box) box.innerHTML=''; return; }
  box.innerHTML=''; for(const c of r.comments){
    const d = document.createElement('div'); d.className='comment';
    d.innerHTML = `<div><b>${escapeHtml(c.name)}</b> • <span class="small">${new Date(c.t).toLocaleString()}</span><div>${escapeHtml(c.text)}</div></div>
      <div style="text-align:right;min-width:160px">
        <button class="reaction" onclick="reviewCommentReact('${reviewId}','${c.id}','likes')">👍 <span class="count">${c.likes||0}</span></button>
        <button class="reaction" onclick="reviewCommentReact('${reviewId}','${c.id}','dislikes')">👎 <span class="count">${c.dislikes||0}</span></button>
        <button class="reaction" onclick="reviewCommentReact('${reviewId}','${c.id}','loves')">❤️ <span class="count">${c.loves||0}</span></button>
        <div style="margin-top:6px"><button class="btn ghost danger" onclick="deleteReviewComment('${reviewId}','${c.id}')">Xóa</button></div>
      </div>`;
    box.appendChild(d);
  }
}
function reviewCommentReact(rid, cid, field){ const a = load(KEY.REVIEWS)||[]; const r = a.find(x=>x.id===rid); if(!r) return; const c = r.comments.find(x=>x.id===cid); if(!c) return; c[field] = (c[field]||0)+1; save(KEY.REVIEWS, a); renderReviewComments(rid); }
function deleteReviewComment(rid, cid){ if(!confirm('Xóa bình luận?')) return; const a = load(KEY.REVIEWS)||[]; const r = a.find(x=>x.id===rid); if(!r) return; r.comments = r.comments.filter(x=>x.id!==cid); save(KEY.REVIEWS, a); renderReviewComments(rid); }

/* ===================== SETTINGS: Auth + Apply ===================== */
function doLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  if(u===AUTH.user && p===AUTH.pass){ sessionStorage.setItem('wol_logged','1'); document.getElementById('loginStatus').innerText='Đã đăng nhập'; alert('Đăng nhập thành công'); }
  else alert('Sai tài khoản/mật khẩu');
}
function doLogout(){ sessionStorage.removeItem('wol_logged'); document.getElementById('loginStatus').innerText='Chưa đăng nhập'; alert('Đã đăng xuất'); }
function isLogged(){ return sessionStorage.getItem('wol_logged')==='1' }

async function applySettings(){
  if(!isLogged()) return alert('Cần đăng nhập để thay đổi cài đặt');
  const newTitle = document.getElementById('newTitle').value.trim();
  const bgFile = document.getElementById('bgFile').files[0];
  const bgUrl = document.getElementById('bgUrl').value.trim();
  const s = load(KEY.SETTINGS) || {};
  if(newTitle){ s.title = newTitle; document.getElementById('siteTitle').innerText = newTitle; }
  if(bgFile){
    try{
      const data = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(bgFile); });
      s.bg = data; document.body.style.backgroundImage = `url('${data}')`;
    }catch(e){ alert('Lỗi đọc file nền'); console.error(e); }
  } else if(bgUrl){
    s.bg = bgUrl; document.body.style.backgroundImage = `url('${bgUrl}')`;
  }
  save(KEY.SETTINGS, s); alert('Lưu cài đặt xong');
}

/* ===================== Init render on load ===================== */
(function init(){
  // apply saved settings
  const s = load(KEY.SETTINGS) || {};
  if(s.title) document.getElementById('siteTitle').innerText = s.title;
  if(s.bg) document.body.style.backgroundImage = `url('${s.bg}')`;

  // default name
  const dn = load(KEY.DEFAULT_NAME); if(dn) document.getElementById('defaultName').value = dn;

  // render data
  renderMediaPosts(); renderStories(); renderReviews(); loadContact();
})();
</script>

</body>
</html>



