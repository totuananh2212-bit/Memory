<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Bida 8 Bi 2D</title>
<style>
  body { display:flex; justify-content:center; align-items:center; height:100vh; background:#2b2b2b; margin:0; font-family:sans-serif; }
  canvas { background:#006400; border:3px solid #fff; }
  #info { position:absolute; top:10px; left:10px; color:#fff; }
  #powerBar { width:200px; height:20px; background:#555; margin-top:5px; }
  #powerFill { height:20px; width:0%; background:red; }
</style>
</head>
<body>
<div id="info">
  <div id="score">Điểm: 0</div>
  <div id="turn">Lượt: Người chơi</div>
  <div id="powerBar"><div id="powerFill"></div></div>
</div>
<canvas id="bida" width="800" height="400"></canvas>

<script>
const canvas = document.getElementById('bida');
const ctx = canvas.getContext('2d');

// Lỗ bàn
const holes = [
  {x:0,y:0},{x:canvas.width/2,y:0},{x:canvas.width,y:0},
  {x:0,y:canvas.height},{x:canvas.width/2,y:canvas.height},{x:canvas.width,y:canvas.height}
];

// 8 bi mục tiêu + bi cái trắng
let balls = [
  {x:100, y:200, r:12, color:'white', vx:0, vy:0, isCue:true, number:0},
  {x:400, y:100, r:12, color:'red', vx:0, vy:0, number:1},
  {x:450, y:150, r:12, color:'orange', vx:0, vy:0, number:2},
  {x:500, y:200, r:12, color:'yellow', vx:0, vy:0, number:3},
  {x:550, y:250, r:12, color:'green', vx:0, vy:0, number:4},
  {x:600, y:150, r:12, color:'blue', vx:0, vy:0, number:5},
  {x:650, y:200, r:12, color:'purple', vx:0, vy:0, number:6},
  {x:700, y:150, r:12, color:'brown', vx:0, vy:0, number:7},
  {x:750, y:200, r:12, color:'black', vx:0, vy:0, number:8}
];

let score = 0;
let turn = "Người chơi";
let currentNumber = 1;
let mouseDown = false;
let mouseStart = {x:0,y:0};

// Vẽ bi với viền và đổ bóng
function drawBallWithEdge(b){
    ctx.save();
    ctx.shadowBlur = 10;
    ctx.shadowOffsetX = 2;
    ctx.shadowOffsetY = 2;
    ctx.shadowColor = 'rgba(0,0,0,0.5)';

    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
    ctx.fillStyle = b.color;
    ctx.fill();
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 3;
    ctx.stroke();

    ctx.restore();
}

// Vẽ bàn
function drawTable(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // lỗ
  holes.forEach(h=>{
    ctx.beginPath();
    ctx.arc(h.x,h.y,15,0,2*Math.PI);
    ctx.fillStyle='black';
    ctx.fill();
  });
  // bi
  balls.forEach(b=> drawBallWithEdge(b));
}

// Cập nhật bi + ma sát
function updateBalls(){
  balls.forEach(b=>{
    b.x += b.vx;
    b.y += b.vy;
    b.vx *= 0.98;
    b.vy *= 0.98;

    // va bi bàn
    if(b.x-b.r<0 || b.x+b.r>canvas.width) b.vx*=-1;
    if(b.y-b.r<0 || b.y+b.r>canvas.height) b.vy*=-1;

    // kiểm tra lỗ
    holes.forEach(h=>{
      const dx = b.x - h.x;
      const dy = b.y - h.y;
      if(Math.sqrt(dx*dx+dy*dy)<15){
        if(b.isCue){
          resetCue();
          switchTurn();
        } else if(b.number === currentNumber){
          score +=1;
          balls = balls.filter(bb=>bb!==b);
          currentNumber +=1;
        } else {
          switchTurn();
        }
      }
    });
  });
}

// Va chạm bi với xử lý đẩy ra khỏi nhau
function detectCollision(){
  for(let i=0;i<balls.length;i++){
    for(let j=i+1;j<balls.length;j++){
      let b1 = balls[i], b2 = balls[j];
      let dx = b2.x - b1.x;
      let dy = b2.y - b1.y;
      let dist = Math.sqrt(dx*dx+dy*dy);
      if(dist < b1.r + b2.r){
        let overlap = (b1.r + b2.r) - dist;
        let nx = dx/dist;
        let ny = dy/dist;
        b1.x -= nx*overlap/2;
        b1.y -= ny*overlap/2;
        b2.x += nx*overlap/2;
        b2.y += ny*overlap/2;

        let angle = Math.atan2(dy,dx);
        let speed1 = Math.sqrt(b1.vx*b1.vx+b1.vy*b1.vy);
        let speed2 = Math.sqrt(b2.vx*b2.vx+b2.vy*b2.vy);
        b1.vx = speed2*Math.cos(angle);
        b1.vy = speed2*Math.sin(angle);
        b2.vx = speed1*Math.cos(angle+Math.PI);
        b2.vy = speed1*Math.sin(angle+Math.PI);
      }
    }
  }
}

// Reset bi cái
function resetCue(){
  let cue = balls.find(b=>b.isCue);
  cue.x = 100;
  cue.y = 200;
  cue.vx=0;
  cue.vy=0;
}

// Đổi lượt
function switchTurn(){
  turn = turn==="Người chơi"?"AI":"Người chơi";
  document.getElementById('turn').innerText = "Lượt: "+turn;
}

// Chuột kéo để đánh
canvas.addEventListener('mousedown', e=>{
  mouseDown=true;
  mouseStart.x=e.offsetX;
  mouseStart.y=e.offsetY;
});

canvas.addEventListener('mousemove', e=>{
  if(mouseDown){
    let dx = e.offsetX - mouseStart.x;
    let dy = e.offsetY - mouseStart.y;
    let power = Math.min(100, Math.sqrt(dx*dx+dy*dy));
    document.getElementById('powerFill').style.width = power + "%";
  }
});

canvas.addEventListener('mouseup', e=>{
  if(mouseDown && turn==="Người chơi"){
    mouseDown=false;
    let cue = balls.find(b=>b.isCue);
    let dx = e.offsetX - mouseStart.x;
    let dy = e.offsetY - mouseStart.y;
    cue.vx = dx/5;
    cue.vy = dy/5;
    document.getElementById('powerFill').style.width = 0;
  }
});

// AI đánh đơn giản
function aiPlay(){
  let cue = balls.find(b=>b.isCue);
  let target = balls.find(b=>b.number===currentNumber);
  if(!target) return;
  let dx = target.x - cue.x + (Math.random()-0.5)*20; 
  let dy = target.y - cue.y + (Math.random()-0.5)*20;
  cue.vx = dx/15;
  cue.vy = dy/15;
}

// Game loop
function gameLoop(){
  updateBalls();
  detectCollision();
  drawTable();
  document.getElementById('score').innerText = "Điểm: "+score;

  if(turn==="AI"){
    let cue = balls.find(b=>b.isCue);
    if(Math.abs(cue.vx)<0.1 && Math.abs(cue.vy)<0.1){
      aiPlay();
    }
  }

  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>

















