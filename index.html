import pygame, random
pygame.init()

# ---- CÀI ĐẶT MÀN HÌNH ----
WIDTH, HEIGHT = 800, 600
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("WOLF by ToAh")
clock = pygame.time.Clock()
FPS = 60

# ---- MÀU SẮC ----
WHITE = (255,255,255)
BLACK = (0,0,0)
BLUE  = (135,206,235)
RED   = (255,0,0)
GREEN = (0,255,0)
YELLOW= (255,255,0)
PURPLE= (128,0,128)
COLOR_OPTIONS = {"GRAY": (192,192,192), "BLUE": (0,0,255), "RED": (255,0,0),
                 "GREEN": (0,255,0), "YELLOW": (255,255,0), "PURPLE": (128,0,128)}
font = pygame.font.SysFont(None, 40)

# ---- LỚP PLAYER ----
class Player(pygame.sprite.Sprite):
    def __init__(self, x, y, color):
        super().__init__()
        self.size = 50
        self.color = color
        self.image = pygame.Surface((self.size,self.size))
        self.image.fill(self.color)
        self.rect = self.image.get_rect(topleft=(x,y))
        self.vel_y = 0
        self.on_ground = False
        self.is_big = False
        self.can_shoot = False
    def update(self, keys):
        dx=dy=0
        if keys[pygame.K_LEFT]: dx=-5
        if keys[pygame.K_RIGHT]: dx=5
        if keys[pygame.K_s] and self.on_ground:
            self.vel_y=-15; self.on_ground=False
        self.vel_y +=1
        if self.vel_y>15: self.vel_y=15
        dy += self.vel_y
        if self.rect.bottom+dy>HEIGHT-50: dy=HEIGHT-50-self.rect.bottom; self.vel_y=0; self.on_ground=True
        self.rect.x += dx; self.rect.y += dy
    def grow(self):
        if not self.is_big:
            self.size=int(self.size*1.5)
            self.image=pygame.Surface((self.size,self.size))
            self.image.fill(self.color)
            self.rect=self.image.get_rect(midbottom=self.rect.midbottom)
            self.is_big=True
            self.can_shoot=True

# ---- LỚP PLATFORM ----
class Platform(pygame.sprite.Sprite):
    def __init__(self,x,y,w,h):
        super().__init__()
        self.image=pygame.Surface((w,h)); self.image.fill(BLACK)
        self.rect=self.image.get_rect(topleft=(x,y))

# ---- LỚP MUSHROOM ----
class Mushroom(pygame.sprite.Sprite):
    def __init__(self,x,y):
        super().__init__()
        self.image=pygame.Surface((30,30)); self.image.fill(RED)
        self.rect=self.image.get_rect(topleft=(x,y))

# ---- LỚP ENEMY ----
class Enemy(pygame.sprite.Sprite):
    def __init__(self,x,y,speed=2):
        super().__init__()
        self.image=pygame.Surface((40,40)); self.image.fill(GREEN)
        self.rect=self.image.get_rect(topleft=(x,y)); self.speed=speed
    def update(self):
        self.rect.x += self.speed
        if self.rect.left<=0 or self.rect.right>=WIDTH: self.speed*=-1

# ---- LỚP FIREBALL ----
class Fireball(pygame.sprite.Sprite):
    def __init__(self,x,y,direction):
        super().__init__()
        self.image=pygame.Surface((15,15)); self.image.fill(YELLOW)
        self.rect=self.image.get_rect(center=(x,y)); self.speed=10*direction
    def update(self):
        self.rect.x += self.speed
        if self.rect.right<0 or self.rect.left>WIDTH: self.kill()

# ---- LỚP BOSS ----
class Boss(pygame.sprite.Sprite):
    def __init__(self,x,y,health=10):
        super().__init__()
        self.image=pygame.Surface((100,100)); self.image.fill(PURPLE)
        self.rect=self.image.get_rect(topleft=(x,y)); self.health=health; self.speed=3
    def update(self):
        self.rect.x += self.speed
        if self.rect.left<=0 or self.rect.right>=WIDTH: self.speed*=-1

# ---- MENU ----
def main_menu():
    name=""; color_keys=list(COLOR_OPTIONS.keys()); color_index=0; selecting=True
    while selecting:
        screen.fill(BLUE)
        screen.blit(font.render("WOLF by ToAh",True,WHITE),(WIDTH//2-100,50))
        screen.blit(font.render(f"Name: {name}",True,WHITE),(WIDTH//2-100,150))
        screen.blit(font.render(f"Color: {color_keys[color_index]}",True,COLOR_OPTIONS[color_keys[color_index]]),(WIDTH//2-100,250))
        screen.blit(font.render("Enter name, UP/DOWN to change color, ENTER to start",True,WHITE),(50,350))
        pygame.display.flip()
        for event in pygame.event.get():
            if event.type==pygame.QUIT: pygame.quit(); exit()
            if event.type==pygame.KEYDOWN:
                if event.key==pygame.K_RETURN and name!="": selecting=False
                elif event.key==pygame.K_BACKSPACE: name=name[:-1]
                elif event.key==pygame.K_UP: color_index=(color_index-1)%len(color_keys)
                elif event.key==pygame.K_DOWN: color_index=(color_index+1)%len(color_keys)
                else:
                    if len(name)<10 and event.unicode.isalnum(): name+=event.unicode
    return name,COLOR_OPTIONS[color_keys[color_index]]

player_name, player_color = main_menu()
player = Player(100, HEIGHT-100, player_color)
player_group = pygame.sprite.Group(); player_group.add(player)

# ---- TẠO MÀN CHƠI ----
def create_level(level):
    platforms=pygame.sprite.Group()
    platforms.add(Platform(0, HEIGHT-50, WIDTH,50))
    platforms.add(Platform(200, 450-20*(level-1), 150,20))
    platforms.add(Platform(500, 350-20*(level-1), 150,20))
    mushrooms=pygame.sprite.Group()
    mushrooms.add(Mushroom(220,420-20*(level-1)))
    mushrooms.add(Mushroom(520,320-20*(level-1)))
    enemies=pygame.sprite.Group()
    for _ in range(level+1): enemies.add(Enemy(random.randint(100,700), HEIGHT-90, speed=2+level))
    bosses=pygame.sprite.Group()
    bosses.add(Boss(WIDTH-200, HEIGHT-150, health=10+level*2))
    return platforms, mushrooms, enemies, bosses

level=1
platforms, mushrooms, enemies, bosses = create_level(level)
fireballs=pygame.sprite.Group()

# ---- GAME LOOP ----
running=True
while running:
    clock.tick(FPS)
    keys=pygame.key.get_pressed()
    screen.fill(BLUE)
    for event in pygame.event.get():
        if event.type==pygame.QUIT: running=False
        if event.type==pygame.KEYDOWN:
            if event.key==pygame.K_f and player.can_shoot:
                direction=1 if keys[pygame.K_RIGHT] else -1
                fireballs.add(Fireball(player.rect.centerx, player.rect.centery,direction))
    player.update(keys)
    enemies.update(); fireballs.update(); bosses.update()

    # Platform collision
    for plat in platforms:
        if player.rect.colliderect(plat.rect) and player.vel_y>=0:
            if player.rect.bottom<=plat.rect.bottom:
                player.rect.bottom=plat.rect.top; player.vel_y=0; player.on_ground=True

    # Nấm
    if pygame.sprite.spritecollide(player,mushrooms,True): player.grow()

    # Quái
    if pygame.sprite.spritecollide(player,enemies,False): print(f"{player_name} bị thương!")

    # Fireball va quái/boss
    for fire in fireballs:
        if pygame.sprite.spritecollide(fire,enemies,True): fire.kill()
        hit_boss=pygame.sprite.spritecollide(fire,bosses,False)
        for b in hit_boss:
            b.health-=1; fire.kill()
            if b.health<=0: b.kill(); print(f"BOSS màn {level} bị tiêu diệt!")
    # Qua màn
    if not bosses:
        level+=1
        if level>5: print("Bạn đã chiến thắng tất cả màn!"); running=False
        else: platforms, mushrooms, enemies, bosses = create_level(level)
        player.rect.topleft=(100, HEIGHT-100)

    # Vẽ
    platforms.draw(screen); mushrooms.draw(screen)
    enemies.draw(screen); bosses.draw(screen)
    fireballs.draw(screen); player_group.draw(screen)
    pygame.display.flip()

pygame.quit()









